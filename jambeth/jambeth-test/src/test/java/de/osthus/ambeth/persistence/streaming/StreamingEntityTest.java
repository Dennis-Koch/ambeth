package de.osthus.ambeth.persistence.streaming;import org.junit.Assert;import org.junit.Test;import de.osthus.ambeth.cache.CacheRetrieverFake;import de.osthus.ambeth.cache.ICache;import de.osthus.ambeth.cache.InputSourceTemplateFake;import de.osthus.ambeth.cache.InputSourceTemplateFakeConverter;import de.osthus.ambeth.cache.transfer.LoadContainer;import de.osthus.ambeth.config.ServiceConfigurationConstants;import de.osthus.ambeth.ioc.CacheModule;import de.osthus.ambeth.ioc.CacheStreamModule;import de.osthus.ambeth.ioc.EventServerModule;import de.osthus.ambeth.ioc.IInitializingModule;import de.osthus.ambeth.ioc.annotation.Autowired;import de.osthus.ambeth.ioc.annotation.FrameworkModule;import de.osthus.ambeth.ioc.config.IBeanConfiguration;import de.osthus.ambeth.ioc.factory.IBeanContextFactory;import de.osthus.ambeth.merge.IEntityFactory;import de.osthus.ambeth.merge.IEntityMetaDataProvider;import de.osthus.ambeth.merge.model.IEntityMetaData;import de.osthus.ambeth.merge.model.IObjRef;import de.osthus.ambeth.merge.transfer.ObjRef;import de.osthus.ambeth.persistence.streaming.StreamingEntityTest.StreamingEntityTestModule;import de.osthus.ambeth.service.ICacheRetriever;import de.osthus.ambeth.stream.binary.IBinaryInputStream;import de.osthus.ambeth.stream.bool.IBooleanInputStream;import de.osthus.ambeth.stream.float32.IFloatInputStream;import de.osthus.ambeth.stream.float64.IDoubleInputStream;import de.osthus.ambeth.stream.int32.IIntInputStream;import de.osthus.ambeth.stream.int64.ILongInputStream;import de.osthus.ambeth.stream.strings.IStringInputStream;import de.osthus.ambeth.testutil.AbstractInformationBusTest;import de.osthus.ambeth.testutil.TestFrameworkModule;import de.osthus.ambeth.testutil.TestProperties;import de.osthus.ambeth.testutil.TestRebuildContext;import de.osthus.ambeth.util.IDedicatedConverterExtendable;@TestProperties(name = ServiceConfigurationConstants.mappingFile, value = "de/osthus/ambeth/persistence/streaming/streaming_orm.xml")@TestFrameworkModule({ StreamingEntityTestModule.class, EventServerModule.class })@TestRebuildContextpublic class StreamingEntityTest extends AbstractInformationBusTest{	@FrameworkModule	public static class StreamingEntityTestModule implements IInitializingModule	{		@Override		public void afterPropertiesSet(IBeanContextFactory beanContextFactory) throws Throwable		{			beanContextFactory.registerBean(CacheModule.DEFAULT_CACHE_RETRIEVER, CacheRetrieverFake.class).autowireable(ICacheRetriever.class);			beanContextFactory.registerAlias(CacheStreamModule.CHUNK_PROVIDER_NAME, CacheModule.DEFAULT_CACHE_RETRIEVER);			IBeanConfiguration istfConverter = beanContextFactory.registerBean(InputSourceTemplateFakeConverter.class);			beanContextFactory.link(istfConverter).to(IDedicatedConverterExtendable.class).with(InputSourceTemplateFake.class, IBinaryInputStream.class);		}	}	@Autowired	protected ICache cache;	@Autowired	protected IEntityFactory entityFactory;	@Autowired	protected IEntityMetaDataProvider entityMetaDataProvider;	@Test	public void streamedBoolean() throws Exception	{		IEntityMetaData metaData = entityMetaDataProvider.getMetaData(StreamingEntity.class);		CacheRetrieverFake cacheRetrieverFake = beanContext.getService(CacheModule.DEFAULT_CACHE_RETRIEVER, CacheRetrieverFake.class);		LoadContainer lc = new LoadContainer();		ObjRef objRef = new ObjRef(StreamingEntity.class, new Integer(1), null);		lc.setReference(objRef);		boolean[] expected = { true, false, true, true, false };		lc.setPrimitives(new Object[metaData.getPrimitiveMembers().length]);		lc.setRelations(new IObjRef[metaData.getRelationMembers().length][]);		lc.getPrimitives()[metaData.getIndexByPrimitiveName("BooleanStreamed")] = new InputSourceTemplateFake(expected);		cacheRetrieverFake.entities.put(lc.getReference(), lc);		StreamingEntity streamingEntity = cache.getObject(StreamingEntity.class, 1);		IBooleanInputStream is = streamingEntity.getBooleanStreamed().deriveBooleanInputStream();		try		{			int index = 0;			while (is.hasBoolean())			{				boolean value = is.readBoolean();				Assert.assertEquals(expected[index++], value);			}		}		finally		{			is.close();		}		Assert.assertNotNull(streamingEntity);	}	@Test	public void streamedDouble() throws Exception	{		IEntityMetaData metaData = entityMetaDataProvider.getMetaData(StreamingEntity.class);		CacheRetrieverFake cacheRetrieverFake = beanContext.getService(CacheModule.DEFAULT_CACHE_RETRIEVER, CacheRetrieverFake.class);		LoadContainer lc = new LoadContainer();		ObjRef objRef = new ObjRef(StreamingEntity.class, new Integer(1), null);		lc.setReference(objRef);		double[] expected = { 5, 4, Double.MAX_VALUE, Double.MIN_VALUE, 0, -1, 5.4321 };		lc.setPrimitives(new Object[metaData.getPrimitiveMembers().length]);		lc.setRelations(new IObjRef[metaData.getRelationMembers().length][]);		lc.getPrimitives()[metaData.getIndexByPrimitiveName("DoubleStreamed")] = new InputSourceTemplateFake(expected);		cacheRetrieverFake.entities.put(lc.getReference(), lc);		StreamingEntity streamingEntity = cache.getObject(StreamingEntity.class, 1);		IDoubleInputStream is = streamingEntity.getDoubleStreamed().deriveDoubleInputStream();		try		{			int index = 0;			while (is.hasDouble())			{				double value = is.readDouble();				Assert.assertEquals(expected[index++], value, Double.MIN_VALUE);			}		}		finally		{			is.close();		}		Assert.assertNotNull(streamingEntity);	}	@Test	public void streamedFloat() throws Exception	{		IEntityMetaData metaData = entityMetaDataProvider.getMetaData(StreamingEntity.class);		CacheRetrieverFake cacheRetrieverFake = beanContext.getService(CacheModule.DEFAULT_CACHE_RETRIEVER, CacheRetrieverFake.class);		LoadContainer lc = new LoadContainer();		ObjRef objRef = new ObjRef(StreamingEntity.class, new Integer(1), null);		lc.setReference(objRef);		float[] expected = { 5, 4, Float.MAX_VALUE, Float.MIN_VALUE, 0, -1, 5.4321f };		lc.setPrimitives(new Object[metaData.getPrimitiveMembers().length]);		lc.setRelations(new IObjRef[metaData.getRelationMembers().length][]);		lc.getPrimitives()[metaData.getIndexByPrimitiveName("FloatStreamed")] = new InputSourceTemplateFake(expected);		cacheRetrieverFake.entities.put(lc.getReference(), lc);		StreamingEntity streamingEntity = cache.getObject(StreamingEntity.class, 1);		IFloatInputStream is = streamingEntity.getFloatStreamed().deriveFloatInputStream();		try		{			int index = 0;			while (is.hasFloat())			{				float value = is.readFloat();				Assert.assertEquals(expected[index++], value, Float.MIN_VALUE);			}		}		finally		{			is.close();		}		Assert.assertNotNull(streamingEntity);	}	@Test	public void streamedInt() throws Exception	{		IEntityMetaData metaData = entityMetaDataProvider.getMetaData(StreamingEntity.class);		CacheRetrieverFake cacheRetrieverFake = beanContext.getService(CacheModule.DEFAULT_CACHE_RETRIEVER, CacheRetrieverFake.class);		LoadContainer lc = new LoadContainer();		ObjRef objRef = new ObjRef(StreamingEntity.class, new Integer(1), null);		lc.setReference(objRef);		int[] expected = { 5, 4, Integer.MAX_VALUE, Integer.MIN_VALUE, 0, -1 };		lc.setPrimitives(new Object[metaData.getPrimitiveMembers().length]);		lc.setRelations(new IObjRef[metaData.getRelationMembers().length][]);		lc.getPrimitives()[metaData.getIndexByPrimitiveName("IntStreamed")] = new InputSourceTemplateFake(expected);		cacheRetrieverFake.entities.put(lc.getReference(), lc);		StreamingEntity streamingEntity = cache.getObject(StreamingEntity.class, 1);		IIntInputStream is = streamingEntity.getIntStreamed().deriveIntInputStream();		try		{			int index = 0;			while (is.hasInt())			{				int value = is.readInt();				Assert.assertEquals(expected[index++], value);			}		}		finally		{			is.close();		}		Assert.assertNotNull(streamingEntity);	}	@Test	public void streamedLong() throws Exception	{		IEntityMetaData metaData = entityMetaDataProvider.getMetaData(StreamingEntity.class);		CacheRetrieverFake cacheRetrieverFake = beanContext.getService(CacheModule.DEFAULT_CACHE_RETRIEVER, CacheRetrieverFake.class);		LoadContainer lc = new LoadContainer();		ObjRef objRef = new ObjRef(StreamingEntity.class, new Integer(1), null);		lc.setReference(objRef);		long[] expected = { 5, 4, Long.MAX_VALUE, Long.MIN_VALUE, 0, -1 };		lc.setPrimitives(new Object[metaData.getPrimitiveMembers().length]);		lc.setRelations(new IObjRef[metaData.getRelationMembers().length][]);		lc.getPrimitives()[metaData.getIndexByPrimitiveName("LongStreamed")] = new InputSourceTemplateFake(expected);		cacheRetrieverFake.entities.put(lc.getReference(), lc);		StreamingEntity streamingEntity = cache.getObject(StreamingEntity.class, 1);		ILongInputStream is = streamingEntity.getLongStreamed().deriveLongInputStream();		try		{			int index = 0;			while (is.hasLong())			{				long value = is.readLong();				Assert.assertEquals(expected[index++], value);			}		}		finally		{			is.close();		}		Assert.assertNotNull(streamingEntity);	}	@Test	public void streamedString() throws Exception	{		IEntityMetaData metaData = entityMetaDataProvider.getMetaData(StreamingEntity.class);		CacheRetrieverFake cacheRetrieverFake = beanContext.getService(CacheModule.DEFAULT_CACHE_RETRIEVER, CacheRetrieverFake.class);		LoadContainer lc = new LoadContainer();		ObjRef objRef = new ObjRef(StreamingEntity.class, new Integer(1), null);		lc.setReference(objRef);		String[] expected = { Integer.toString(5), Integer.toString(4), Integer.toString(Integer.MAX_VALUE), null, Integer.toString(Integer.MAX_VALUE),				Integer.toString(0), Integer.toString(-1) };		lc.setPrimitives(new Object[metaData.getPrimitiveMembers().length]);		lc.setRelations(new IObjRef[metaData.getRelationMembers().length][]);		lc.getPrimitives()[metaData.getIndexByPrimitiveName("StringStreamed")] = new InputSourceTemplateFake(expected);		cacheRetrieverFake.entities.put(lc.getReference(), lc);		StreamingEntity streamingEntity = cache.getObject(StreamingEntity.class, 1);		IStringInputStream is = streamingEntity.getStringStreamed().deriveStringInputStream();		try		{			int index = 0;			while (is.hasString())			{				String value = is.readString();				Assert.assertEquals(expected[index++], value);			}		}		finally		{			is.close();		}		Assert.assertNotNull(streamingEntity);	}}