package de.osthus.ambeth.persistence.external.compositeid;import org.junit.Assert;import org.junit.Test;import de.osthus.ambeth.cache.CacheDirective;import de.osthus.ambeth.cache.CacheRetrieverFake;import de.osthus.ambeth.cache.ICache;import de.osthus.ambeth.compositeid.ICompositeIdFactory;import de.osthus.ambeth.config.ServiceConfigurationConstants;import de.osthus.ambeth.ioc.CacheModule;import de.osthus.ambeth.ioc.EventServerModule;import de.osthus.ambeth.ioc.IInitializingModule;import de.osthus.ambeth.ioc.annotation.FrameworkModule;import de.osthus.ambeth.ioc.config.IBeanConfiguration;import de.osthus.ambeth.ioc.factory.IBeanContextFactory;import de.osthus.ambeth.merge.IEntityFactory;import de.osthus.ambeth.merge.IEntityMetaDataProvider;import de.osthus.ambeth.merge.model.IEntityMetaData;import de.osthus.ambeth.merge.transfer.ObjRef;import de.osthus.ambeth.persistence.external.compositeid.CompositeIdExternalEntityTest.CompositeIdExternalEntityTestModule;import de.osthus.ambeth.service.ICacheRetrieverExtendable;import de.osthus.ambeth.testutil.AbstractInformationBusTest;import de.osthus.ambeth.testutil.TestFrameworkModule;import de.osthus.ambeth.testutil.TestProperties;import de.osthus.ambeth.util.IPrintable;import de.osthus.ambeth.util.ParamChecker;@TestProperties(name = ServiceConfigurationConstants.mappingFile, value = "de/osthus/ambeth/persistence/external/compositeid/external_orm.xml")@TestFrameworkModule({ CompositeIdExternalEntityTestModule.class, EventServerModule.class })public class CompositeIdExternalEntityTest extends AbstractInformationBusTest{	@FrameworkModule	public static class CompositeIdExternalEntityTestModule implements IInitializingModule	{		@Override		public void afterPropertiesSet(IBeanContextFactory beanContextFactory) throws Throwable		{			beanContextFactory.registerBean(CacheModule.DEFAULT_CACHE_RETRIEVER, CacheRetrieverFake.class);			IBeanConfiguration bc = beanContextFactory.registerAnonymousBean(CompositeIdEntityCacheRetriever.class);			beanContextFactory.link(bc).to(ICacheRetrieverExtendable.class).with(CompositeIdEntity.class);			beanContextFactory.link(bc).to(ICacheRetrieverExtendable.class).with(CompositeIdEntity2.class);		}	}	protected ICache cache;	protected ICompositeIdFactory compositeIdFactory;	protected IEntityFactory entityFactory;	protected IEntityMetaDataProvider entityMetaDataProvider;	@Override	public void afterPropertiesSet() throws Throwable	{		super.afterPropertiesSet();		ParamChecker.assertNotNull(cache, "cache");		ParamChecker.assertNotNull(compositeIdFactory, "compositeIdFactory");		ParamChecker.assertNotNull(entityFactory, "entityFactory");		ParamChecker.assertNotNull(entityMetaDataProvider, "entityMetaDataProvider");	}	public void setCache(ICache cache)	{		this.cache = cache;	}	public void setCompositeIdFactory(ICompositeIdFactory compositeIdFactory)	{		this.compositeIdFactory = compositeIdFactory;	}	public void setEntityFactory(IEntityFactory entityFactory)	{		this.entityFactory = entityFactory;	}	public void setEntityMetaDataProvider(IEntityMetaDataProvider entityMetaDataProvider)	{		this.entityMetaDataProvider = entityMetaDataProvider;	}	@Test	public void testCompositeIdBehaviorEquals() throws Exception	{		IEntityMetaData metaData = entityMetaDataProvider.getMetaData(CompositeIdEntity.class);		Object left = compositeIdFactory.createCompositeId(metaData, metaData.getIdMember(), CompositeIdEntityCacheRetriever.id1_2_data[0],				CompositeIdEntityCacheRetriever.id1_2_data[1]);		Object right = compositeIdFactory.createCompositeId(metaData, metaData.getIdMember(), CompositeIdEntityCacheRetriever.id1_2_data[0],				CompositeIdEntityCacheRetriever.id1_2_data[1]);		Assert.assertNotNull(left);		Assert.assertNotNull(right);		Assert.assertNotSame(left, right);		Assert.assertEquals(left, right);		Assert.assertTrue(left instanceof IPrintable);		StringBuilder sb = new StringBuilder();		((IPrintable) left).toString(sb);		Assert.assertEquals(left.toString(), sb.toString());	}	@Test	public void testCompositeIdBehaviorNotEqual() throws Exception	{		IEntityMetaData metaData = entityMetaDataProvider.getMetaData(CompositeIdEntity.class);		Object left = compositeIdFactory.createCompositeId(metaData, metaData.getIdMember(), CompositeIdEntityCacheRetriever.id1_2_data[0],				CompositeIdEntityCacheRetriever.id1_2_data[1]);		Object right = compositeIdFactory.createCompositeId(metaData, metaData.getIdMember(),				((Number) CompositeIdEntityCacheRetriever.id1_2_data[0]).intValue() + 2, CompositeIdEntityCacheRetriever.id1_2_data[1]);		Assert.assertNotNull(left);		Assert.assertNotNull(right);		Assert.assertNotSame(left, right);		Assert.assertFalse(left.equals(right));		int idIndex = 0;		Object right2 = compositeIdFactory.createCompositeId(metaData, metaData.getAlternateIdMembers()[idIndex],				CompositeIdEntityCacheRetriever.id1_2_data[4], ((Number) CompositeIdEntityCacheRetriever.id1_2_data[3]).shortValue() + 2);		Assert.assertNotNull(right2);		Assert.assertNotSame(left, right2);		Assert.assertFalse(left.equals(right2));	}	@Test	public void testPrimaryId() throws Exception	{		IEntityMetaData metaData = entityMetaDataProvider.getMetaData(CompositeIdEntity.class);		Object compositeId = compositeIdFactory.createCompositeId(metaData, metaData.getIdMember(), CompositeIdEntityCacheRetriever.id1_2_data[0],				CompositeIdEntityCacheRetriever.id1_2_data[1]);		CompositeIdEntity entity = cache.getObject(CompositeIdEntity.class, compositeId);		Assert.assertNotNull(entity);		Assert.assertEquals(CompositeIdEntityCacheRetriever.id1_2_data[0], entity.getId1());		Assert.assertEquals(CompositeIdEntityCacheRetriever.id1_2_data[1], entity.getId2());		Assert.assertEquals(CompositeIdEntityCacheRetriever.id1_2_data[2], entity.getName());		Assert.assertEquals(CompositeIdEntityCacheRetriever.id1_2_data[3], entity.getAid1());		Assert.assertEquals(CompositeIdEntityCacheRetriever.id1_2_data[4], entity.getAid2());	}	@Test	public void testAlternateId() throws Exception	{		int idIndex = 0;		IEntityMetaData metaData = entityMetaDataProvider.getMetaData(CompositeIdEntity.class);		Object compositeId = compositeIdFactory.createCompositeId(metaData, metaData.getAlternateIdMembers()[idIndex],				CompositeIdEntityCacheRetriever.id1_2_data[4], CompositeIdEntityCacheRetriever.id1_2_data[3]);		CompositeIdEntity entity = (CompositeIdEntity) cache.getObject(new ObjRef(CompositeIdEntity.class, (byte) idIndex, compositeId, null),				CacheDirective.none());		Assert.assertNotNull(entity);		Assert.assertEquals(CompositeIdEntityCacheRetriever.id1_2_data[0], entity.getId1());		Assert.assertEquals(CompositeIdEntityCacheRetriever.id1_2_data[1], entity.getId2());		Assert.assertEquals(CompositeIdEntityCacheRetriever.id1_2_data[2], entity.getName());		Assert.assertEquals(CompositeIdEntityCacheRetriever.id1_2_data[3], entity.getAid1());		Assert.assertEquals(CompositeIdEntityCacheRetriever.id1_2_data[4], entity.getAid2());	}	@Test	public void testPrimaryIdEmbedded() throws Exception	{		IEntityMetaData metaData = entityMetaDataProvider.getMetaData(CompositeIdEntity2.class);		Object compositeId = compositeIdFactory.createCompositeId(metaData, metaData.getIdMember(), CompositeIdEntityCacheRetriever.id1_2_data[0],				CompositeIdEntityCacheRetriever.id1_2_data[1]);		CompositeIdEntity2 entity = cache.getObject(CompositeIdEntity2.class, compositeId);		Assert.assertNotNull(entity);		Assert.assertEquals(CompositeIdEntityCacheRetriever.entity2_id1_2_data[0], entity.getId1());		Assert.assertEquals(CompositeIdEntityCacheRetriever.entity2_id1_2_data[1], entity.getId2().getSid());		Assert.assertEquals(CompositeIdEntityCacheRetriever.entity2_id1_2_data[2], entity.getName());		Assert.assertEquals(CompositeIdEntityCacheRetriever.entity2_id1_2_data[3], entity.getAid1());		Assert.assertEquals(CompositeIdEntityCacheRetriever.entity2_id1_2_data[4], entity.getAid2().getSid());	}	@Test	public void testAlternateIdEmbedded() throws Exception	{		int idIndex = 0;		IEntityMetaData metaData = entityMetaDataProvider.getMetaData(CompositeIdEntity2.class);		Object compositeId = compositeIdFactory.createCompositeId(metaData, metaData.getAlternateIdMembers()[idIndex],				CompositeIdEntityCacheRetriever.entity2_id1_2_data[4], CompositeIdEntityCacheRetriever.entity2_id1_2_data[3]);		CompositeIdEntity2 entity = (CompositeIdEntity2) cache.getObject(new ObjRef(CompositeIdEntity2.class, (byte) idIndex, compositeId, null),				CacheDirective.none());		Assert.assertNotNull(entity);		Assert.assertEquals(CompositeIdEntityCacheRetriever.entity2_id1_2_data[0], entity.getId1());		Assert.assertEquals(CompositeIdEntityCacheRetriever.entity2_id1_2_data[1], entity.getId2().getSid());		Assert.assertEquals(CompositeIdEntityCacheRetriever.entity2_id1_2_data[2], entity.getName());		Assert.assertEquals(CompositeIdEntityCacheRetriever.entity2_id1_2_data[3], entity.getAid1());		Assert.assertEquals(CompositeIdEntityCacheRetriever.entity2_id1_2_data[4], entity.getAid2().getSid());	}}